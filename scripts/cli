#!/bin/bash

set -euo pipefail

PATH="$PATH:node_modules/.bin"

main () {
  if [[ $# -lt 1 ]]; then
    cmd_help
  fi

  local command="cmd_$1"
  shift

  "$command" "$@"
}

cmd_help () {
  local available_commands=$(set | perl -nle'print $& while m{^cmd_\K\w+}g')
  echo -e "Available commands:\n$available_commands"
  exit 1
}

cmd_typecheck () {
  local project_path="${1}"
  tsc -p "$project_path" --noEmit true
}

cmd_lint () {
  local project_path="${1}"
  biome check "$project_path" --diagnostic-level=error
}

cmd_release () {
  [[ `git branch --show-current` != "main" ]] || fail 'please do not release from `main` branch'
  # We should publish all packages regardless of if there are changes in each.
  # --force-publish will skip the `lerna changed` check for changed packages
  yarn lerna version --exact --force-publish
}

cmd_version () {
#  node ./scripts/release/generate-changelog TODO: auto-generate changelog
  node ./scripts/release/update-peer-dependency-versions.js
  lerna run pack --stream
  # keep test apps lockfiles up to date
  for app_package_path in $(git ls-files test/apps/*/package.json 2>/dev/null || true); do
    app_dir=$(dirname "$app_package_path");
    cd "$app_dir"
    yarn up
    git add yarn.lock
    cd - > /dev/null
  done
}

cmd_build_testing_extensions () {
  echo "No testing extensions to build for openfeature-js-client"
}

cmd_check_server_side_rendering_compatibility () {
  yarn build
  yarn lerna run pack --stream
  echo "SSR compatibility check not implemented for openfeature-js-client"
}

cmd_woke () {
  command -v woke || fail 'woke not installed, see https://github.com/get-woke/woke#installation'
  woke --exit-1-on-failure
}

fail () {
  echo
  echo "‚ùå ${1}"
  echo

  exit 1
}

main "$@" 